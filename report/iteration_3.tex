\section{Iteration \#3 -- $kd$-Tree Exploration}

This iteration explores a widely used index structure based on spatial decomposition, instead of using dimension reduction via a hashing function. One implementation of the structure is evaluated alongside the best performing hash-based approaches from the previous iterations.

\subsection{Point $kd$-Tree}

The $kd$-Tree variant described in Section \ref{sec:kd-tree-chosen} was implemented, which shall be referred to as the \textbf{Point $kd$-Tree}. Each node is represented as a C-struct which stores a single point as well as pointers to its children. Every node is allocated using a call to \texttt{malloc()}, which allocates enough memory on the heap to store the node. This means each node may reside in different areas of the heap, resulting in fragmented memory.=

\subsection{Performance Timings}

TODO

\begin{table}
	\centering
	\makebox[\textwidth][c]{%
		\begin{tabular}{|r|r|l|l|l|l|l|l|l|l|}
			\hline
			\multicolumn{2}{|c}{} & \multicolumn{8}{|c|}{\textbf{Dimensionality}} \\
			\hline
			\textbf{Structure} & \textbf{Operation} & 1 & 2 & 3 & 5 & 10 & 50 & 100 & 200 \\
			\hline
			\multirow{3}{*}{Bucket PPT} & Insert & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
			\hline			
			\multirow{3}{*}{Bucket PT} & Insert & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
			\hline			
			\multirow{3}{*}{Bucket Hash Table} & Insert & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
			\hline
			\multirow{3}{*}{Point $kd$-Tree} & Insert & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO & TODO & TODO & TODO & TODO \\
			\hline
		\end{tabular}
	}%

	\caption{Total Execution Time (in seconds) of Each Operation for Varying Number of Dimensions in Uniformly Distributed Synthetic Dataset}
	\label{tab:perf3-dimensionality}
\end{table}

\begin{figure}
	\begin{center}
		\begin{subfloat}[\texttt{insert}\label{fig:perf3-dimensionality-insert}]{%
			\includegraphics[scale=0.25]{figures/uniform_distribution.pdf}
		}
		\end{subfloat}~
		\begin{subfloat}[\texttt{remove}\label{fig:perf3-dimensionality-remove}]{%
			\includegraphics[scale=0.25]{figures/uniform_distribution.pdf}
		}
		\end{subfloat}~
	\end{center}

	\caption{Index Structure Performance With Respect To Dimensionality (10,000 Points from Uniform Distribution Synthetic Dataset)}
	\label{fig:perf3-dimensionality}
\end{figure}

\begin{table}
	\centering
	\makebox[\textwidth][c]{%
		\begin{tabular}{|r|r|l|l|l|l|}
			\hline
			\multicolumn{2}{|c}{} & \multicolumn{4}{|c|}{\textbf{Points in Dataset}} \\
			\hline
			\textbf{Structure} & \textbf{Operation} & 10,000 & 100,000 & 500,000 & 1,000,000 \\
			\hline
			\multirow{3}{*}{Bucket PPT} & Insert & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO \\
			\hline			
			\multirow{3}{*}{Bucket PT} & Insert & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO \\
			\hline			
			\multirow{3}{*}{Bucket Hash Table} & Insert & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO \\
			\hline
			\multirow{3}{*}{Point $kd$-Tree} & Insert & TODO & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO & TODO \\
			\hline
		\end{tabular}
	}%

	\caption{Total Execution Time (in seconds) of Each Operation for Varying Number of Points in Uniformly Distributed Synthetic Dataset}
	\label{tab:perf3-size}
\end{table}

\begin{figure}
	\begin{center}
		\begin{subfloat}[\texttt{insert}\label{fig:perf3-size-insert}]{%
			\includegraphics[scale=0.25]{figures/uniform_distribution.pdf}
		}
		\end{subfloat}~
		\begin{subfloat}[\texttt{remove}\label{fig:perf3-size-remove}]{%
			\includegraphics[scale=0.25]{figures/uniform_distribution.pdf}
		}
		\end{subfloat}~
	\end{center}

	\caption{Index Structure Performance With Respect To Dataset Size (10,000 Points from Uniform Distribution Synthetic Dataset)}
	\label{fig:perf3-size}
\end{figure}


\begin{table}
	\centering
	\makebox[\textwidth][c]{%
		\begin{tabular}{|r|r|l|l|l|}
			\hline
			\multicolumn{2}{|c}{} & \multicolumn{3}{|c|}{\textbf{Dataset}} \\
			\hline
			\textbf{Structure} & \textbf{Operation} & \textbf{Astrophysics} & \textbf{Hurricane Isabel} & \textbf{Armadillo Mesh} \\
			\hline
			\multirow{4}{*}{Bucket PPT} & Insert & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO \\
				& Random Operation List & TODO & TODO & TODO \\
			\hline
			\multirow{4}{*}{Bucket PT} & Insert & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO \\
				& Random Operation List & TODO & TODO & TODO \\
			\hline
			\multirow{4}{*}{Bucket Hash Table} & Insert & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO \\
				& Random Operation List & TODO & TODO & TODO \\
			\hline
			\multirow{4}{*}{Point $kd$-Tree} & Insert & TODO & TODO & TODO \\
				& Delete & TODO & TODO & TODO \\
				& PQuery & TODO & TODO & TODO \\
				& Random Operation List & TODO & TODO & TODO \\
			\hline
		\end{tabular}
	}%

	\caption{Total Execution Time (in seconds) of Each Operation for 500,000 Points Sampled From Real Datasets}
	\label{tab:perf3-real}
\end{table}

\subsection{$kd$-Tree Balance}

The performance timings in the previous section show that the $kd$-tree becomes slower with particular datasets. Despite the $kd$-Tree storing the same number of points in each of the real datasets, the performance is different. The speed of processing 500,000 points from the astrophysics or hurricane Isabel datasets is much slower than the armadillo mesh or the synthetic datasets. 

The cause of this is most likely the \textit{balance} of the tree. Skewed datasets are known to affect the balance of spatial decomposition trees, resulting in longer paths from the root node to the leaves. To investigate this further, the \textit{balance factor} of the point $kd$-tree, when storing 500,000 points from three synthetic and three real datasets has been measured. The balance factor is defined as the \textit{average} length of a path from the root to a leaf. A lower balance factor means the $kd$-Tree has to visit less nodes on average when performing a point query, so queries will generally be faster. A $kd$-Tree is balanced when its balance factor is $\log_2 n$. When $n = 500,000$, the best possible balance factor is $\log_2 (500,000) \approx 19$. 

\begin{table}
	\centering
	\begin{tabular}{|l|l|l|l|}
		\hline
		\textbf{Dataset} & \textbf{Balance Factor} & \textbf{Max Path Length} & \textbf{Time to Query All Points (seconds)} \\
		\hline
		Random 10D Points (Uniform Distribution) & 24.8285 & 47 & 0.591447 \\
		Random 10D Points (Skewed Distribution) & 24.9092 & 44 & 0.602856 \\
		Random 10D Points (Clustered Distribution) & 30.3362 & 57 & 0.479269 \\
		Astrophysics & 32.405 & 120 & 0.65575 \\
		Hurricane Isabel & 47.7236 & 123 & 0.466654 \\
		\hline
	\end{tabular}
	\caption{Point $kd$-Tree Balance Factor with 500,000 Points from Various Datasets}
	\label{tab:kdtree-balance-factor}
\end{table}

The balance factor clearly increases as $n$ is increased, so the concern here is how its affected by data distribution. Table \ref{tab:kdtree-balance-factor} contains the balance factor and maximum path length from the root to a leaf when the point $kd$-Tree is storing 500,000 points from different datasets. Here we see there appears to be little correlation between balance factor and query execution time. 

Despite the hurricane Isabel dataset introducing a higher balance factor and having three more dimensions than the astrophysics dataset, execution time 
so point comparisons take longer)

TODO: comment on results

\subsection{Summary}

This iteration showed that the point $kd$-tree, even with no attempts to further optimise the structure, significantly outperformed the Pseudo-Pyramid Tree and Pyramid Tree. The point $kd$-Tree is slightly slower than the Bucket Hash Table, but is more resilient to floating point inaccuracy as it does not rely on a potentially inaccurate hashing function. TODO: findings from skd-tree balance section